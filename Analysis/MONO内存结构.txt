// Mono 运行时 64 位内存布局
// 说明：该文件只陈述 External 当前实现依赖到的字段/偏移语义。
// 约定：所有偏移均为字节偏移，从结构体起始地址算起。

// 0. Mono 托管对象头与类型元数据（GetManagedType 的读取路径）
struct MonoManagedObjectHeader {
    MonoVTableInternal* vtable;  // 0x00  虚表指针
    void*               monitor; // 0x08  同步锁（GetManagedType 不依赖，但 +0x10 nativeObject 需要该占位）
};

struct MonoVTableInternal {
    MonoClassInternal* klass;    // 0x00  类元数据指针
};

struct MonoClassInternal {
    char        pad_0000[0x48]; // 0x00  保留
    const char* name;           // 0x48  类名
    const char* namespaze;      // 0x50  命名空间
};

// 1. Managed -> Native 桥接（External 依赖的固定偏移）
struct MonoManagedGameObject : MonoManagedObjectHeader {
    void* nativeObject; // 0x10  原生对象指针 -> MonoNativeGameObject*
};

struct MonoManagedComponent : MonoManagedObjectHeader {
    void* nativeObject; // 0x10  原生组件指针 -> MonoNativeComponent*
};

// 2. Native GameObject（External 依赖字段）
struct MonoNativeGameObject {
    char   pad_0000[0x28];      // 0x00  保留
    void*  managedObject;       // 0x28  托管对象指针 -> MonoManagedGameObject*
    void*  componentPool;       // 0x30  组件池指针（slot 数组起始地址）
    char   pad_0038[0x8];       // 0x38  保留
    int    componentCount;      // 0x40  组件数量
    char   pad_0044[0x10];      // 0x44  保留
    int    tagRaw;              // 0x54  tagRaw（取低 16 位作为 tagId）
    char   pad_0058[0x8];       // 0x58  保留
    char*  namePtr;             // 0x60  名称字符串指针
};

// 3. Native Component（External 依赖字段）
struct MonoNativeComponent {
    char     pad_0000[0x28];    // 0x00  保留
    void*    managedComponent;  // 0x28  托管组件指针 -> MonoManagedComponent*
    void*    gameObject;        // 0x30  GameObject 指针
    std::uint8_t enabled;       // 0x38  启用状态（GetComponentEnabled 读取，非 0 为 true）
};

// 4. ComponentPool（slot 数组布局，External 依赖字段）
// 说明：componentPool 指向 slot 数组起始地址（不是“带头部的结构体”）。
//      slotStride = 0x10。
struct MonoComponentSlot {
    int    typeId;              // 0x00  类型 ID
    int    pad_0004;            // 0x04  padding
    void*  nativeComponent;     // 0x08  原生组件指针
};

// 5. GOM（GameObjectManager buckets，与运行时无关）
struct MonoGameObjectManager {
    void* buckets;              // 0x00  哈希桶数组指针
    int   bucketCount;          // 0x08  桶数量
};

struct MonoBucket {
    uint32_t hashMask;          // 0x00  哈希掩码
    uint32_t info;              // 0x04  4字节信息/前缀
    uint64_t key;               // 0x08  键值
    void*    listHead;          // 0x10  链表头指针
};

struct MonoGameObjectNode {
    MonoGameObjectNode* pLast;  // 0x00  前一个节点
    MonoGameObjectNode* pNext;  // 0x08  后一个节点
    void*               nativeObject; // 0x10  原生 GameObject 指针
};